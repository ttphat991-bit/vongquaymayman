<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V√≤ng quay may m·∫Øn</title>

<style>
:root{
    --bg:#020617;
    --card:#0f172a;
    --primary:#22c55e;
}
*{box-sizing:border-box}
body{
    margin:0;
    min-height:100vh;
    background:radial-gradient(circle at top,#2563eb,#020617);
    display:flex;
    justify-content:center;
    align-items:center;
    font-family:Arial,sans-serif;
    color:#fff;
}
.game{
    background:var(--card);
    width:100%;
    max-width:420px;
    padding:20px;
    border-radius:20px;
    box-shadow:0 25px 50px rgba(0,0,0,.5);
}
.top{
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.admin-btn{
    background:none;border:none;
    color:#fff;font-size:22px;cursor:pointer;
}
.wheel-box{
    position:relative;
    width:100%;
    aspect-ratio:1;
}
canvas{
    width:100%;height:100%;
    background:#fff;border-radius:50%;
}
.pointer{
    position:absolute;
    top:-14px; /* s√°t h∆°n */
    left:50%;
    transform:translateX(-50%);
    border-left:16px solid transparent;
    border-right:16px solid transparent;
    border-top:34px solid #ef4444;
    filter:drop-shadow(0 2px 2px rgba(0,0,0,.4));
}

button{
    width:100%;margin-top:15px;
    padding:14px;font-size:16px;
    font-weight:bold;border:none;
    border-radius:12px;
    background:var(--primary);
    cursor:pointer;
}
button:disabled{background:#64748b}
.result{text-align:center;margin-top:10px;font-size:18px}
.history,.admin{
    margin-top:15px;
    background:#020617;
    padding:10px;border-radius:12px;
    font-size:14px;
}
.history div{border-bottom:1px solid #1e293b;padding:4px 0}
.admin{display:none}
.admin-row{
    display:flex;gap:6px;margin-bottom:6px
}
.admin-row span{flex:1}
.admin-row input{width:70px}
.admin table{
    width:100%;border-collapse:collapse;font-size:12px
}
.admin th,.admin td{
    border-bottom:1px solid #1e293b;
    padding:4px;text-align:center
}
.confetti{
    position:fixed;inset:0;pointer-events:none
}
.confetti span{
    position:absolute;width:8px;height:14px;
    animation:fall linear forwards
}
@keyframes fall{
    to{transform:translateY(100vh) rotate(360deg);opacity:0}
}
.admin-bottom{
    margin-top:20px;
    width:100%;
    padding:12px;
    font-size:15px;
    border-radius:12px;
    background:#1e293b;
    color:#fff;
    cursor:pointer;
}
@keyframes pointerBounce {
    0%   { transform: translateX(-50%) rotate(0deg); }
    30%  { transform: translateX(-50%) rotate(-12deg); }
    60%  { transform: translateX(-50%) rotate(6deg); }
    100% { transform: translateX(-50%) rotate(0deg); }
}

.pointer.bounce {
    animation: pointerBounce 0.4s ease-out;
}



</style>
</head>
<body>

<div class="game">
    <div class="top">
        <h2>üé° V√≤ng quay may m·∫Øn</h2>
        
    </div>

    <div class="wheel-box">
        <div class="pointer"></div>
        <canvas id="wheel"></canvas>
    </div>

    <button id="spin">QUAY NGAY</button>
    <div class="result" id="result"></div>

    <div class="history">
        <b>üìú L·ªãch s·ª≠</b>
        <div id="history"></div>
    </div>
	
    <div class="admin" id="admin">
        <h3>üîß Admin ch·ªânh % (KH·ªöP 100%)</h3>
        <div id="adminList"></div>

        <h3>üìä Th·ªëng k√™ th·ª±c t·∫ø</h3>
        <div id="stats"></div>
        <button id="resetStats">‚ôª Reset th·ªëng k√™</button>
    </div>
	<button class="admin-btn admin-bottom" id="adminToggle">
    ‚öôÔ∏è C√†i ƒë·∫∑t
</button>
</div>


<div class="confetti" id="confetti"></div>

<audio id="spinSound" src="amthanh/slotmachine.mp3"></audio>
<audio id="winSound" src="amthanh/winner-game-sound-404167.mp3"></audio>
<audio id="clickSound" src="amthanh/wooden-click.wav"></audio>


<script>
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const spinBtn = document.getElementById("spin");
const resultEl = document.getElementById("result");
const historyEl = document.getElementById("history");
const adminBox = document.getElementById("admin");
const adminList = document.getElementById("adminList");
const statsBox = document.getElementById("stats");
const confettiBox = document.getElementById("confetti");
const spinSound = document.getElementById("spinSound");
const winSound = document.getElementById("winSound");
const clickSound = document.getElementById("clickSound");
let lastSliceIndex = null; // d√πng ƒë·ªÉ ch·ªëng ph√°t tr√πng ti·∫øng



/* ===== RESPONSIVE ===== */
function resize(){
    const s = canvas.parentElement.clientWidth;
    canvas.width = s;
    canvas.height = s;
}
window.addEventListener("resize", resize);
resize();

/* ===== DATA ===== */
let prizes = JSON.parse(localStorage.getItem("prizes")) || [
    { text:"üéÅ 100.000ƒë", chance:20, color:"#fde047" },
    { text:"üéâ 50.000ƒë", chance:20, color:"#86efac" },
    { text:"üí∞ 200.000ƒë", chance:10, color:"#93c5fd" },
    { text:"üò¢ Ch√∫c may m·∫Øn", chance:20, color:"#fca5a5" },
    { text:"üéÅ 20.000ƒë", chance:25, color:"#c4b5fd" },
    { text:"üéä 500.000ƒë", chance:5, color:"#fcd34d" }
];

let history = JSON.parse(localStorage.getItem("history") || "[]");
let stats = JSON.parse(localStorage.getItem("stats")) || {
    total: 0,
    items: prizes.map(() => 0)
};

let rotation = 0;
let fixedPrizeIndex = null;
let highlightIndex = null; // √¥ c·∫ßn v·∫Ω vi·ªÅn s√°ng
let highlightPulse = 0;   // d√πng cho hi·ªáu ·ª©ng nh·∫•p nh√°y


/* ===== EP TONG % = 100 ===== */
function totalChance(){
    return prizes.reduce((s,p)=>s + Number(p.chance || 0), 0);
}

/* ===== SLICE ===== */
function getSlices(){
    const count = prizes.length;
    const angle = (Math.PI * 2) / count;

    return prizes.map((_, i)=>({
        start: i * angle,
        angle: angle
    }));
}



/* ===== DRAW ===== */
function draw(rot = 0){
    const c = canvas.width/2;
    const r = c - 5;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const slices = getSlices();
    slices.forEach((s,i)=>{
        ctx.beginPath();
        ctx.moveTo(c,c);
        ctx.arc(c,c,r, s.start+rot, s.start+s.angle+rot);
        ctx.fillStyle = prizes[i].color;
        ctx.fill();

        ctx.save();
        ctx.translate(c,c);
        ctx.rotate(s.start + s.angle/2 + rot);
        ctx.textAlign="right";
        ctx.font=`bold ${Math.max(12,canvas.width/25)}px Arial`;
        ctx.fillStyle="#000";
        ctx.fillText(prizes[i].text, r-10, 5);
        ctx.restore();
    });
	    // ‚ú® V·∫º VI·ªÄN S√ÅNG √î TR√öNG
    if (highlightIndex !== null) {
        const s = slices[highlightIndex];
        ctx.save();
        ctx.beginPath();
        ctx.arc(c, c, r - 2, s.start + rot, s.start + s.angle + rot);
        ctx.strokeStyle = "rgba(255,215,0,0.9)";
        ctx.lineWidth = 8;
        ctx.shadowBlur = 20;
        ctx.shadowColor = "#fde047";
        ctx.stroke();
        ctx.restore();
    }
	    // ‚ú® VI·ªÄN S√ÅNG NH·∫§P NH√ÅY √î TR√öNG
    if (highlightIndex !== null) {
        const s = slices[highlightIndex];

        // t·∫°o hi·ªáu ·ª©ng pulse
        highlightPulse += 0.08;
        const glow = 6 + Math.sin(highlightPulse) * 4;

        ctx.save();
        ctx.beginPath();
        ctx.arc(c, c, r - 2, s.start + rot, s.start + s.angle + rot);
        ctx.strokeStyle = "rgba(255,215,0,0.95)";
        ctx.lineWidth = glow;
        ctx.shadowBlur = 15 + glow * 2;
        ctx.shadowColor = "#fde047";
        ctx.stroke();
        ctx.restore();
    }


}
draw();

/* ===== RANDOM ===== */
function pickPrize(){
    let r = Math.random() * 100;
    for(let i=0;i<prizes.length;i++){
        r -= prizes[i].chance;
        if(r<=0) return i;
    }
}

/* ===== HISTORY ===== */
function renderHistory(){
    historyEl.innerHTML = history.map(h=>`<div>${h}</div>`).join("");
}
renderHistory();

/* ===== STATS ===== */
function renderStats(){
    const totalCfg = totalChance();
    let warn = "";
    if(totalCfg !== 100){
        warn = `<div style="color:#f87171;font-weight:bold;margin-bottom:6px">
        ‚ö†Ô∏è T·ªïng % c·∫•u h√¨nh = ${totalCfg}% (PH·∫¢I = 100%)
        </div>`;
    }

    if(!stats.total){
        statsBox.innerHTML = warn + "<i>Ch∆∞a c√≥ d·ªØ li·ªáu</i>";
        return;
    }

    let html=`<table>
        <tr><th>Ph·∫ßn th∆∞·ªüng</th><th>% c·∫•u h√¨nh</th><th>L∆∞·ª£t</th><th>% th·ª±c t·∫ø</th></tr>`;
    prizes.forEach((p,i)=>{
        const real=((stats.items[i]/stats.total)*100).toFixed(2);
        html+=`<tr>
            <td>${p.text}</td>
            <td>${p.chance}%</td>
            <td>${stats.items[i]}</td>
            <td>${real}%</td>
        </tr>`;
    });
    html+=`<tr>
        <th>T·ªïng</th>
        <th>${totalCfg}%</th>
        <th>${stats.total}</th>
        <th>100%</th>
    </tr></table>`;

    statsBox.innerHTML = warn + html;
}

/* ===== CONFETTI ===== */
function confetti(){
    confettiBox.innerHTML="";
    for(let i=0;i<80;i++){
        const s=document.createElement("span");
        s.style.left=Math.random()*100+"%";
        s.style.background=`hsl(${Math.random()*360},100%,50%)`;
        s.style.animationDuration=2+Math.random()*2+"s";
        confettiBox.appendChild(s);
        setTimeout(()=>s.remove(),4000);
    }
}

/* ===== SPIN ===== */
spinBtn.onclick = () => {
	lastSliceIndex = null;
	highlightIndex = null; // reset vi·ªÅn c≈©
    const total = totalChance();
    if (total !== 100) {
        alert("‚ö†Ô∏è T·ªïng % ph·∫£i = 100%");
        return;
    }

    spinBtn.disabled = true;
    spinSound.currentTime = 0;
    spinSound.play();
	
	// chu·∫©n ho√° g√≥c tr∆∞·ªõc khi quay
	rotation = rotation % (Math.PI * 2)

    // üîí ch·ªçn k·∫øt qu·∫£ DUY NH·∫§T
    const i = fixedPrizeIndex !== null
        ? fixedPrizeIndex
        : pickPrize();

    const slices = getSlices();
    const mid = slices[i].start + slices[i].angle / 2;

    // kim ·ªü 12 gi·ªù
    const pointerAngle = -Math.PI / 2;

    // g√≥c c·∫ßn d·ª´ng
    const target = pointerAngle - (mid + rotation);
	
	
	
    // üîë G√ìC B·∫ÆT ƒê·∫¶U & K·∫æT TH√öC (QUAN TR·ªåNG)
    const startAngle = rotation;
    const endAngle = startAngle + 6 * Math.PI * 2 + target;

    const startTime = performance.now();
    const dur = 4000;

    function anim(t) {
        const p = Math.min((t - startTime) / dur, 1);
        const e = 1 - Math.pow(1 - p, 3);

        // üî• V·∫º THEO G√ìC THAY ƒê·ªîI TH·ª∞C S·ª∞
        const currentAngle = startAngle + (endAngle - startAngle) * e;
        draw(currentAngle);
		
		// üîä T·∫†CH THEO T·ªêC ƒê·ªò QUAY (NH·ªé ‚Üí TO)
		const slices = getSlices();
		const sliceAngle = slices[0].angle;

		// g√≥c kim (12 gi·ªù)
		const pointerAngle = -Math.PI / 2;

		// g√≥c kim so v·ªõi v√≤ng quay
		let relativeAngle = (pointerAngle - currentAngle) % (Math.PI * 2);
		if (relativeAngle < 0) relativeAngle += Math.PI * 2;

		// x√°c ƒë·ªãnh kim ƒëang ·ªü √¥ n√†o
		const currentSlice = Math.floor(relativeAngle / sliceAngle);

		// % th·ªùi gian c√≤n l·∫°i (0 ‚Üí 1)
		const remain = 1 - p;

		if (currentSlice !== lastSliceIndex) {
			clickSound.pause();
			clickSound.currentTime = 0;

			// √¢m l∆∞·ª£ng: quay nhanh nh·ªè ‚Äì g·∫ßn d·ª´ng to
			clickSound.volume = Math.min(1, 0.2 + (1 - remain) * 0.9);

			clickSound.play();
			lastSliceIndex = currentSlice;

			// rung kim ƒë·ªìng b·ªô
			bouncePointer(0.12 + (1 - remain) * 0.25);
			// üì≥ rung theo t·ªëc ƒë·ªô
			
		}
		if (remain > 0.6) {
				vibratePhone(10);          // quay nhanh ‚Üí rung r·∫•t nh·∫π
			} else if (remain > 0.3) {
				vibratePhone(20);          // ch·∫≠m d·∫ßn
			} else {
				vibratePhone([30, 20, 30]); // g·∫ßn d·ª´ng
			}
		
		

		

        if (p < 1) {
            requestAnimationFrame(anim);
        } else {
            // l∆∞u l·∫°i g√≥c cu·ªëi
            rotation = endAngle;
			highlightIndex = i;
			draw(rotation); // v·∫Ω l·∫°i ƒë·ªÉ th·∫•y vi·ªÅn s√°ng

            spinSound.pause();
            winSound.play();
			// üì≥ RUNG M·∫†NH KHI TR√öNG
			vibratePhone([60, 30, 60, 30, 100]);
			// üîä T·∫†CH M·∫†NH √î TR√öNG
			clickSound.pause();
			clickSound.currentTime = 0;
			clickSound.volume = 1;
			clickSound.play();

			// rung kim m·∫°nh khi tr√∫ng
			bouncePointer(0.6);
			
			
			
			const pointer = document.querySelector(".pointer");
			pointer.classList.remove("bounce"); // reset
			void pointer.offsetWidth;           // force reflow
			pointer.classList.add("bounce");

            resultEl.textContent = "üéØ Tr√∫ng: " + prizes[i].text;

            confetti();

            history.unshift(new Date().toLocaleString() + " ‚Äî " + prizes[i].text);
            history = history.slice(0, 10);
            localStorage.setItem("history", JSON.stringify(history));
            renderHistory();

            stats.total++;
            stats.items[i]++;
            localStorage.setItem("stats", JSON.stringify(stats));
            renderStats();

            spinBtn.disabled = false;
			
			

			
        }
    }

    requestAnimationFrame(anim);
};



/* ===== ADMIN ===== */
document.getElementById("adminToggle").onclick=()=>{
    adminBox.style.display = adminBox.style.display==="block"?"none":"block";
    adminList.innerHTML="";
    prizes.forEach((p,i)=>{
        const row=document.createElement("div");
        row.className="admin-row";
        row.innerHTML=`<span>${p.text}</span>
        <input type="number" value="${p.chance}" min="0">`;
        const input = row.querySelector("input");
        input.onchange=e=>{
            p.chance = +e.target.value;
            localStorage.setItem("prizes",JSON.stringify(prizes));

            const total = totalChance();
            if(total !== 100){
                input.style.border="2px solid red";
            }else{
                document.querySelectorAll(".admin-row input")
                    .forEach(i=>i.style.border="");
            }

            stats.items = prizes.map(()=>0);
            stats.total = 0;
            localStorage.setItem("stats",JSON.stringify(stats));
            draw(rotation);
            renderStats();
        };
        adminList.appendChild(row);
    });
    renderStats();
};

document.getElementById("resetStats").onclick=()=>{
    if(confirm("Reset th·ªëng k√™?")){
        stats={total:0,items:prizes.map(()=>0)};
        localStorage.setItem("stats",JSON.stringify(stats));
        renderStats();
    }
};

// üîî RUNG KIM THEO C∆Ø·ªúNG ƒê·ªò
function bouncePointer(power = 0.3) {
    const pointer = document.querySelector(".pointer");
    if (!pointer) return;

    pointer.style.animation = "none";
    pointer.offsetHeight; // force reflow

    pointer.style.animation =
        `pointerBounce ${0.25 + power}s ease-out`;
}

// üì≥ RUNG ƒêI·ªÜN THO·∫†I (SAFE)
function vibratePhone(pattern) {
    if (!("vibrate" in navigator)) return;
    navigator.vibrate(pattern);
}


// üîÅ LOOP NH·∫§P NH√ÅY VI·ªÄN S√ÅNG
function highlightLoop() {
    if (highlightIndex !== null) {
        draw(rotation);
    }
    requestAnimationFrame(highlightLoop);
}
highlightLoop();
</script>

</body>
</html>


